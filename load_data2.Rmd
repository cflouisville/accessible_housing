---
title: "Accessible Housing"
output:
  html_document:
    css: styles.css
    accent: "#7bdcb5"
    self_contained: false
    toc: yes
    toc_float: yes
    code_folding: hide
date: "2025-11-25"
knit: (function(inputFile, encoding) { rmarkdown::render(inputFile, encoding = encoding, output_file = file.path(dirname(inputFile), 'docs/index.html')) })
---

```{r setup, echo=FALSE, message=FALSE, warning=FALSE}
#install.packages('showtext', dependencies = TRUE) #for montserrat font in ggplot

library(showtext)
library(glptools)
glp_load_packages(T)

font_add_google("Montserrat", "Montserrat")
knitr::opts_chunk$set(echo = FALSE, warning = FALSE, message = FALSE, cache = FALSE,  
                      dev.args=list(bg="transparent"), fig.width=9, fig.height=6) 

```

```{r read_data, eval = FALSE}
# Analyze ACS disability data
# Read in data

# @Morgan this file is so named because it is ACS Microdata that is cut down to just counties/FIPS (as opposed to observations across the MSA, which takes longer to read in and work with) and includes replicate weights.

options(arrow.skip_nul = TRUE)

#"C:/Users/harri/OneDrive/GLP/glpdata/data-raw/microdata/acs_micro_FIPS_repwts.feather"



acs_micro <- arrow::read_feather("C:/Users/harri/OneDrive/GLP/glpdata/data-raw/microdata/acs_micro_FIPS_repwts.feather")

disability_data <- acs_micro %>%
  filter(year >= 2008, FIPS == "21111")

save(disability_data, file = "interim_data/acs_micro_subset.RData")

=======
acs_micro <- arrow::read_feather("C:/Users/morga/OneDrive - The Community Foundation of Louisville, Inc/acs_micro_FIPS_repwts.feather")

# base_example <- acs_micro[acs_micro$FIPS == "21111",]
# 
# dplyr_example <- filter(acs_micro, FIPS == "21111")
# 
# dplyr_example2 <- acs_micro %>%
#   filter(FIPS == "21111")
# 
# acs_micro %<>% #modify in place
#   filter(FIPS == "21111")
# 
# dploy_example3 <- acs_micro %>%
#   select(FIPS, race)
# 
# deplyr_example4 <- acs_micro %>%
#   select(FIPS, race) %>%   # Chopping down to columns!
#   filter(FIPS == "21111")
# 
# 
# disability_data[1:100,] %>% select(dis_physical)

disability_data <- acs_micro %>%
 filter(year >= 2008, FIPS == "21111")
```

```{r clean_data, eval = FALSE}
# Clean data, set grouping variables

# The ACS disability questions were significantly modified in 2008, so we will only use data from 2008 onward so that all of the years are comparable. Limit scope to Lou to make code faster initially- may undo subset later

#Morgan- load("C:/Users/morga/OneDrive - The Community Foundation of Louisville, Inc/acs_micro_subset.RData")

# RECODE DISABILITY VARIABLES. Find info here: https://usa.ipums.org/usa/index.shtml
# @Morgan case_when evaluates from top to bottom. If the value on the left is true, it assigns the value on the right.

disability_data %<>%
  mutate(
    # Ambulatory difficulty
    dis_physical = case_when(
      DIFFPHYS == 0 ~ NA, #tilde indicates formula
      DIFFPHYS == 1 ~ F,
      DIFFPHYS == 2 ~ T),
    
    # Independent living difficulty
    dis_independent = case_when(
      DIFFMOB == 0 ~ NA,
      DIFFMOB == 1 ~ F,
      DIFFMOB == 2 ~ T), 
    
    # Self-care difficulty
    dis_selfcare  = case_when(
      DIFFCARE  == 0 ~ NA,
      DIFFCARE  == 1 ~ F,
      DIFFCARE  == 2 ~ T), 
    
    # Vision difficulty
    dis_vision = case_when(
      DIFFEYE == 0 ~ NA,
      DIFFEYE == 1 ~ F,
      DIFFEYE == 2 ~ T), 
    
    # Hearing difficulty
    dis_hearing  = case_when(
      DIFFHEAR  == 0 ~ NA,
      DIFFHEAR  == 1 ~ F,
      DIFFHEAR  == 2 ~ T),
    
    # Vision or hearing difficulty (DIFFSENS) not included for now 
    
    # Any disabling condition
    # @Morgan switching up the syntax for funsies :)
    # R is a "vectorized" programming language. One of the most poweful aspects of R, and the hardest to wrap your head around, is when things are happening within individual row elements vs. across entire column vectors. For example, the plus operator here works within individual rows. If you were to use the sum function instead, it would add up all of the values within the columns. If I did that, I would find that dis_any would be T for every observation because sum(those variables) would evaluate to like 300000 for every single row.
    dis_any = if_else((dis_physical + dis_independent + dis_selfcare + dis_vision + dis_hearing) > 0, T, F),
    
    # RECODE OTHER CATEGORY VARIABLES
    # Age group- Not sure how many buckets I want, so I make two versions! We will see what provides meaningful information, and how deep we can disaggregate before the data becomes to noisy.
    
    age_group_3 = case_when(      
      age %in% 5:18 ~ "5_18",
      age %in% 19:64 ~ "19_64",
      age > 65 ~ "65+"),
    
    #age group found in Harvard Survey Analysis -M
    age_group_4 = case_when( 
      age < 50 ~ "Under 50", 
      age %in% 51:64 ~ "50-64", 
      age %in% 65:80 ~ "65-80", 
      age > 80 ~ "80 or Older"), 
    
    age_group_9 = case_when(
      age %in% 0:9 ~ NA_character_, #@Morgan NA can have different types! NA alone is a logical. Common source of errors.
      age %in% 10:19 ~ "10_19", 
      age %in% 20:29 ~ "20_29", 
      age %in% 30:39 ~ "30_39",  
      age %in% 40:49 ~ "40_49",  
      age %in% 50:59 ~ "50_59",  
      age %in% 60:69 ~ "60_69", 
      age %in% 70:79 ~ "70_79", 
      age >= 80 ~ "80+"),
    
  # Income group
  # @Morgan the relevant income in this situation is probably household income over individual earnings. Unlike other variables included here, this is the same for all members of a household.
  #^ so do we use income in our individual demographic breakdown charts at all? -M
  
    HHINCOME = replace(HHINCOME, HHINCOME == 99999, NA),
  
    income_group = case_when(
      HHINCOME < 20000 ~ "Under 20k",
      HHINCOME >= 20000 & HHINCOME < 50000 ~ "20k–49.9k",
      HHINCOME >= 50000 & HHINCOME < 75000 ~ "50k–74.9k",
      HHINCOME >= 75000 & HHINCOME < 100000 ~ "75k–99.9k",
      HHINCOME >= 100000 & HHINCOME < 150000 ~ "100k–149.9k",
      HHINCOME >= 150000 ~ "150k+",
      TRUE ~ NA_character_  ),  # catch-all for missing/unspecified values, "TRUE" could also be "is.na(HHICOME)"
  
  # Homeownership- Not sure if we'll use them all. Rent vs. own for sure, unsure about others.
  
    OWNCOST  = replace(OWNCOST, OWNCOST == 99999, NA),
    OWNERSHP = replace(OWNERSHP, OWNERSHP == 0, NA),
    RENTGRS  = replace(RENTGRS, RENTGRS == 0 & OWNERSHP == 1, NA),

    homeownership = if_else(OWNERSHP == 1, T, F),

    hcost = if_else(homeownership == 1, OWNCOST, RENTGRS),
    cost_burden = if_else(hcost * 12 / HHINCOME > 0.3, T, F),
    severe_cost_burden = if_else(hcost * 12 / HHINCOME > 0.5, 1, 0),

    hh_type = case_when(
      homeownership  & !cost_burden ~ "noncb_homeowner",
      homeownership  & cost_burden  ~ "cb_homeowner",
      !homeownership & !cost_burden ~ "noncb_renter",
      !homeownership & cost_burden  ~ "cb_renter",
      TRUE ~ NA_character_)
    
    )

# MB Checking the disability variable recode. The colon selects several columns. Nifty!
# disability_data[1:100,] %>% select(dis_physical:dis_any)


## HOUSEHOLD
# @Morgan this makes a variable that flags whether anyone in the household (HH) has a disability!!

disability_data %<>%
  
  #@MB HHs are identified by unique values of SERIAL. (SERIAL is repeated across years, hence the need to group by year as well)
  group_by(year, SERIAL) %>% 
  
  #@MB back to vectorized! The verb any is looking up and down the small subset of observations we have created for each HH via group_by to see if dis_physical is true in any of the rows. This type of operation usually takes way longer than simple row-wise operations, so this code is suuuuuper slow.
  
  mutate(
    any_dis_physical    = if_else(any(dis_physical), T, F), 
    any_dis_independent = if_else(any(dis_independent), T, F),
    any_dis_selfcare    = if_else(any(dis_selfcare), T, F),
    any_dis_vision      = if_else(any(dis_vision), T, F),
    any_dis_hearing     = if_else(any(dis_hearing), T, F),
    any_dis_any         = if_else(any(dis_any), T, F)) %>% #@MB lol at this naming convention :)

  ungroup() 

#@MB saving 
arrow::write_feather(disability_data, "interim_data/disability_data.feather")


```

```{r initial_calcs, eval = FALSE}
# ## Process data
# 
# This takes the data that was read, filtered, processed, and saved above and does calculations.

disability_data <- arrow::read_feather("interim_data/disability_data.feather")

# What percentage of Louisvillians have a disability?

# @Morgan, the GLP code does have fairly crappy documentation that you can access in R! e.g. ?survey_by_demog
# But the documentation is at times outdated or incomplete. You can always view inside the function, particularly to see what arguments are provided.

# All disabilities x race and sex
individual_dis_physical    <- survey_by_demog(disability_data, "dis_physical",    "PERWT")
individual_dis_independent <- survey_by_demog(disability_data, "dis_independent", "PERWT")
individual_dis_selfcare    <- survey_by_demog(disability_data, "dis_selfcare",    "PERWT")
individual_dis_vision      <- survey_by_demog(disability_data, "dis_vision",      "PERWT")
individual_dis_hearing     <- survey_by_demog(disability_data, "dis_hearing",     "PERWT")
individual_dis_any         <- survey_by_demog(disability_data, "dis_any",         "PERWT")

# Combine data frames
# @MB: the functions for you to know are left_join and full_join, etc.
# This would work here because the data frame starts out super organized and the columns in common are tidy, but normally you need to do more specification on which columns are supposed to match up, etc.
# individual_dis <- left_join(individual_dis_physical, individual_dis_independent)
# individual_dis <- left_join(individual_dis, individual_dis_selfcare)
# ...

# Custom glptools shortcut
individual_dis <- bind_df(individual_dis_physical, 
                          individual_dis_independent,
                          individual_dis_selfcare,
                          individual_dis_vision,
                          individual_dis_hearing,
                          individual_dis_any)

# Clean up the environment
rm(individual_dis_physical, individual_dis_independent, individual_dis_selfcare, individual_dis_vision,
   individual_dis_hearing, individual_dis_any)


# @MB turns out I DID write this code to let us group by other variables! Lit.
# Physical disability X age, income, and homeownership X race and sex

individual_dis_age_3 <- survey_by_demog(disability_data, 
                                        "dis_physical", 
                                        "PERWT", 
                                        other_grouping_vars = "age_group_3")

individual_dis_age_4 <- survey_by_demog(disability_data, 
                                        "dis_physical", 
                                        "PERWT", 
                                        other_grouping_vars = "age_group_4")

individual_dis_age_9 <- survey_by_demog(disability_data, 
                                        "dis_physical", 
                                        "PERWT", 
                                        other_grouping_vars = "age_group_9")

individual_dis_income <- survey_by_demog(disability_data, 
                                         "dis_physical", 
                                         "PERWT", 
                                         other_grouping_vars = "income_group")


individual_dis_homeownership <- survey_by_demog(disability_data, 
                                                "dis_physical", 
                                                "PERWT", 
                                                other_grouping_vars = "homeownership")

dis_vars <- c("dis_physical", "dis_independent", "dis_selfcare", "dis_vision", "dis_hearing")


income_and_hearing <- survey_by_demog(disability_data, 
                                         "dis_hearing", 
                                         "PERWT", 
                                         other_grouping_vars = "income_group")

                                        

# What percentage of Louisville households include a person with a disability?

# @MB Every person within a household is identified by PERNUM. Variables that apply to the household will have the same value for every individual in that household, so we just need one row per household. We filter to just the first person in each household with PERNUM == 1.

disability_data_hh <- disability_data %>%
  filter(PERNUM == 1)

# Individual-level demographics don't apply at the household level, i.e. race and gender. I use breakdowns == "total" to stop creating numbers by race and gender. But income and homeownership still do apply.

# All disabilities

household_dis_physical    <- survey_by_demog(disability_data_hh, "any_dis_physical",    "HHWT", breakdowns = "total") 
household_dis_independent <- survey_by_demog(disability_data_hh, "any_dis_independent", "HHWT", breakdowns = "total")
household_dis_selfcare    <- survey_by_demog(disability_data_hh, "any_dis_selfcare",    "HHWT", breakdowns = "total") 
household_dis_vision      <- survey_by_demog(disability_data_hh, "any_dis_vision",      "HHWT", breakdowns = "total") 
household_dis_hearing     <- survey_by_demog(disability_data_hh, "any_dis_hearing",     "HHWT", breakdowns = "total") 
household_dis_any         <- survey_by_demog(disability_data_hh, "any_dis_any",         "HHWT", breakdowns = "total") 

household_dis <- bind_df(household_dis_physical, 
                         household_dis_independent,
                         household_dis_selfcare,
                         household_dis_vision,
                         household_dis_hearing,
                         household_dis_any)

# Clean up the environment
rm(household_dis_physical, household_dis_independent, household_dis_selfcare, household_dis_vision,
   household_dis_hearing, household_dis_any)

#@MB note HHWT rather than PERWT 

# Physical disability x income and homeownership
household_dis_income <- survey_by_demog(disability_data_hh, 
                                         "any_dis_physical", 
                                         "HHWT", 
                                         other_grouping_vars = "income_group",
                                         breakdowns = "total")

household_dis_homeownership <- survey_by_demog(disability_data_hh, 
                                               "any_dis_physical", 
                                               "HHWT", 
                                               other_grouping_vars = "homeownership",
                                               breakdowns = "total")
save(individual_dis, 
     individual_dis_age_3,
     individual_dis_age_4,
     individual_dis_age_9,
     individual_dis_income,
     individual_dis_homeownership,
     household_dis, 
     household_dis_income,
     household_dis_homeownership, 
     file = "interim_data/clean_disability_data.RData")
```

```{r create_income_table_HH, eval = FALSE}
# make tables for income and each disability category
income_and_physical <- survey_by_demog(disability_data, "dis_physical", "PERWT", 
                                       other_grouping_vars = "income_group")
income_and_independent <- survey_by_demog(disability_data, "dis_independent", "PERWT",
                                          other_grouping_vars = "income_group")
income_and_selfcare <- survey_by_demog(disability_data, "dis_selfcare","PERWT", 
                                       other_grouping_vars = "income_group")
income_and_vision <- survey_by_demog(disability_data, "dis_vision","PERWT", 
                                     other_grouping_vars = "income_group")
income_and_hearing <- survey_by_demog(disability_data, "dis_hearing", "PERWT", 
                                      other_grouping_vars = "income_group")
income_and_any <- survey_by_demog(disability_data, "dis_any", "PERWT",  
                                  other_grouping_vars = "income_group")

# @Harrison using left_join here bc bind_df() was creating a lot of income_group.x.xx etc and i didn't know how to prevent that so...
income_all <- income_and_hearing %>%
  left_join(income_and_independent, 
            by = c("FIPS","year","sex","race","var_type","income_group")) %>%
  left_join(income_and_physical, 
            by = c("FIPS","year","sex","race","var_type","income_group")) %>%
  left_join(income_and_vision, 
            by = c("FIPS","year","sex","race","var_type","income_group")) %>%
  left_join(income_and_any, 
            by = c("FIPS","year","sex","race","var_type","income_group")) %>%
  left_join(income_and_selfcare, 
            by = c("FIPS","year","sex","race","var_type","income_group"))

# time for cleanup
rm(income_and_any, income_and_hearing, income_and_independent, income_and_physical, income_and_selfcare, income_and_vision)

#make income group a factor so legend will be correctly ordered 
income_levels <- c("Under 20k", "20k–49.9k","50k–74.9k", "75k–99.9k", "100k–149.9k", "150k+")

income_all <- income_all %>%
  mutate(income_group = factor(income_group, levels = income_levels))

save(income_all, file= "interim_data/income_6_all_dis.RData")
```

```{r create_own_vs_rent_table, eval= FALSE}
homeownership_dis_physical <- survey_by_demog(disability_data, "dis_physical", "PERWT", 
                                       other_grouping_vars = "homeownership")
homeownership_dis_independent <- survey_by_demog(disability_data, "dis_independent", "PERWT",
                                          other_grouping_vars = "homeownership")
homeownership_dis_selfcare <- survey_by_demog(disability_data, "dis_selfcare","PERWT", 
                                       other_grouping_vars = "homeownership")
homeownership_dis_vision <- survey_by_demog(disability_data, "dis_vision","PERWT", 
                                     other_grouping_vars = "homeownership")
homeownership_dis_hearing <- survey_by_demog(disability_data, "dis_hearing", "PERWT", 
                                      other_grouping_vars = "homeownership")
homeownership_dis_any <- survey_by_demog(disability_data, "dis_any", "PERWT",  
                                  other_grouping_vars = "homeownership")

homeownership_all <- homeownership_dis_physical %>%
  left_join(homeownership_dis_independent, by = c("FIPS","year","sex","race","var_type","homeownership")) %>%
  left_join(homeownership_dis_selfcare, by = c("FIPS","year","sex","race","var_type","homeownership")) %>%
  left_join(homeownership_dis_vision, by = c("FIPS","year","sex","race","var_type","homeownership")) %>%
  left_join(homeownership_dis_hearing, by = c("FIPS","year","sex","race","var_type","homeownership")) %>%
  left_join(homeownership_dis_any, by = c("FIPS","year","sex","race","var_type","homeownership"))

#clean
rm(homeownership_dis_physical, homeownership_dis_independent, 
   homeownership_dis_selfcare, homeownership_dis_vision, 
   homeownership_dis_hearing, homeownership_dis_any)

save(homeownership_all, file = "interim_data/homeownership_all_dis.RData")
```

```{r hh_homeownership, eval=FALSE}
disability_data <- arrow::read_feather("interim_data/disability_data.feather")

disability_data_hh <- disability_data %>%
  filter(PERNUM == 1)

hh_homeownership_dis_physical <- survey_by_demog(disability_data_hh, "dis_physical", "HHWT", 
                                       other_grouping_vars = "homeownership")
hh_homeownership_dis_independent <- survey_by_demog(disability_data_hh, "dis_independent", "HHWT",
                                          other_grouping_vars = "homeownership")
hh_homeownership_dis_selfcare <- survey_by_demog(disability_data_hh, "dis_selfcare","HHWT", 
                                       other_grouping_vars = "homeownership")
hh_homeownership_dis_vision <- survey_by_demog(disability_data_hh, "dis_vision","HHWT", 
                                     other_grouping_vars = "homeownership")
hh_homeownership_dis_hearing <- survey_by_demog(disability_data_hh, "dis_hearing", "HHWT", 
                                      other_grouping_vars = "homeownership")
hh_homeownership_dis_any <- survey_by_demog(disability_data_hh, "dis_any", "HHWT",  
                                  other_grouping_vars = "homeownership")

hh_homeownership_all <- hh_homeownership_dis_physical %>%
  left_join(hh_homeownership_dis_independent, by = c("FIPS","year","sex","race","var_type","homeownership")) %>%
  left_join(hh_homeownership_dis_selfcare, by = c("FIPS","year","sex","race","var_type","homeownership")) %>%
  left_join(hh_homeownership_dis_vision, by = c("FIPS","year","sex","race","var_type","homeownership")) %>%
  left_join(hh_homeownership_dis_hearing, by = c("FIPS","year","sex","race","var_type","homeownership")) %>%
  left_join(hh_homeownership_dis_any, by = c("FIPS","year","sex","race","var_type","homeownership"))

#clean
rm(hh_homeownership_dis_physical, hh_homeownership_dis_independent, 
   hh_homeownership_dis_selfcare, hh_homeownership_dis_vision, 
   hh_homeownership_dis_hearing, hh_homeownership_dis_any)

save(hh_homeownership_all, file = "interim_data/hh_homeownership_all_dis.RData")
```

```{r hh_income, eval=FALSE}
disability_data <- arrow::read_feather("interim_data/disability_data.feather")

disability_data_hh <- disability_data %>%
  filter(PERNUM == 1)

hh_income_dis_physical <- survey_by_demog(disability_data_hh, "dis_physical", "HHWT", 
                                       other_grouping_vars = "income_group")
hh_income_dis_independent <- survey_by_demog(disability_data_hh, "dis_independent", "HHWT",
                                          other_grouping_vars = "income_group")
hh_income_dis_selfcare <- survey_by_demog(disability_data_hh, "dis_selfcare","HHWT", 
                                       other_grouping_vars = "income_group")
hh_income_dis_vision <- survey_by_demog(disability_data_hh, "dis_vision","HHWT", 
                                     other_grouping_vars = "income_group")
hh_income_dis_hearing <- survey_by_demog(disability_data_hh, "dis_hearing", "HHWT", 
                                      other_grouping_vars = "income_group")
hh_income_dis_any <- survey_by_demog(disability_data_hh, "dis_any", "HHWT",  
                                  other_grouping_vars = "income_group")

hh_income_all <- hh_income_dis_physical %>%
  left_join(hh_income_dis_independent, by = c("FIPS","year","sex","race","var_type","income_group")) %>%
  left_join(hh_income_dis_selfcare, by = c("FIPS","year","sex","race","var_type","income_group")) %>%
  left_join(hh_income_dis_vision, by = c("FIPS","year","sex","race","var_type","income_group")) %>%
  left_join(hh_income_dis_hearing, by = c("FIPS","year","sex","race","var_type","income_group")) %>%
  left_join(hh_income_dis_any, by = c("FIPS","year","sex","race","var_type","income_group"))

#clean
rm(hh_income_dis_physical, hh_income_dis_independent, 
   hh_income_dis_selfcare, hh_income_dis_vision, 
   hh_income_dis_hearing, hh_income_dis_any)

income_levels <- c("Under 20k", "20k–49.9k","50k–74.9k", "75k–99.9k", "100k–149.9k", "150k+")

hh_income_all <- hh_income_all %>%
  mutate(income_group = factor(income_group, levels = income_levels))

save(hh_income_all, file = "interim_data/hh_income_all_dis.RData")
```

```{r create_age_table, eval = FALSE}

#make big table 
group_var <- "age_group_4"

age_and_physical <- survey_by_demog(disability_data, "dis_physical", "PERWT", 
                                    other_grouping_vars = "age_group_4")
age_and_independent <- survey_by_demog(disability_data, "dis_independent", "PERWT",
                                       other_grouping_vars = group_var)
age_and_selfcare <- survey_by_demog(disability_data, "dis_selfcare", "PERWT", 
                                    other_grouping_vars = group_var)
age_and_vision <- survey_by_demog(disability_data, "dis_vision", "PERWT", 
                                  other_grouping_vars = group_var)
age_and_hearing <- survey_by_demog(disability_data, "dis_hearing", "PERWT", 
                                   other_grouping_vars = group_var)
age_and_any <- survey_by_demog(disability_data, "dis_any", "PERWT",  
                               other_grouping_vars = group_var)

age_all <- age_and_hearing %>%
  left_join(age_and_independent, by = c("FIPS","year","sex","race","var_type", group_var)) %>%
  left_join(age_and_physical,   by = c("FIPS","year","sex","race","var_type", group_var)) %>%
  left_join(age_and_vision,     by = c("FIPS","year","sex","race","var_type", group_var)) %>%
  left_join(age_and_any,        by = c("FIPS","year","sex","race","var_type", group_var)) %>%
  left_join(age_and_selfcare,   by = c("FIPS","year","sex","race","var_type", group_var))

#factorize so legend is ordered
age_levels <- c("Under 50", "50-64", "65-80", "80 or Older")

age_all <- age_all %>%
  mutate(age_group_4 = factor(age_group_4, levels = age_levels, ordered = TRUE))

rm(age_and_any, age_and_hearing, age_and_independent, age_and_physical, age_and_selfcare, age_and_vision)

save(age_all, file = "interim_data/age_4_all_dis.RData")
```

```{r skip, eval=FALSE}
## @MB: Processing by hand

# @MB You asked to see the code that does the work in the above.
# The more specific function is glptools:::svy_repwts. It's long because it creates multiple different outputs (i.e. not only does it make the number we're looking for, but also the MOE, confidence interval, etc.)
# The actual code that summarizes the data is:
#
# results_estimate %<>%
#   group_by(across(all_of(c(grouping_vars, var)))) %>%
#   summarise(estimate = sum(.data[[weight_var]]), .groups = "drop")

# To write that with the specific variables used here: 
# This filters to rows where none of the columns specified in that character vector are NA.
# It can be complicated to figure out when to use quoted vs. unquoted variable names. While filter normally works with unquoted variables, I need to use quoted strings for Dplyr to use if_all to find them in the data frame, then apply the formula ~!is.na(.) to them all.

example_df <- disability_data %>%
  filter(if_all(c("FIPS", "year", "sex", "race", "dis_physical"), ~!is.na(.))) 

# Count the number of cases for each value of dis_physical within each demographic category.
example_df %<>%
  group_by(FIPS, year, sex, race, dis_physical) %>%
  summarise(estimate = sum(PERWT), .groups = "drop") #You can either use ungroup() the function, or specify .groups = "drop" to ungroup data.

# Summarize the data and create a percentage
example_df %<>%
  
  # Note that I'm not grouping by dis_physical here. This creates "mini-data frames" where each one has exactly three rows: one for each value of dis_physical. (T, F, & NA)
  group_by(FIPS, year, sex, race) %>% 
  
  mutate(
    population = sum(estimate), # Add together cases where dis_physical is TRUE and dis_physical is FALSE. 
    percent  = estimate / population * 100) %>%
  ungroup()

example_df %<>%
  filter(dis_physical) %>% # I just want the rows where this is true
  select(-dis_physical)
```

```{r skip2, eval = FALSE}
# ## Revisiting some things
# 
# survey_by_demog is mainly a wrapper function that calls svy_repwts or svy_bootstrap multiple times and combines the results.
# 
# The notation in R to access a function without loading in a package (or to specify the package to address conflicts in the namespace) is a double colon. Some packages, including glptools, include functions that are not loaded into the namespace at all. Those are available via triple colon.

# The confidence intervals tend to fall apart at small values.
# Bootstrapping is a method used to generate confidence intervals by re-sampling the observations themselves. It does discard some information the Census bakes in via their replicate weights, but notably, it provides separate numbers for the lower bound and upper bound, rather than one MOE and CI.

# Bootstrapping a year of data in Louisville, for example, looks like taking the observations for Louisville, taking 1,000 samples from those observations, then looking at the spread of those samples

# I am largely unable to follow my own code to create bootstrap weights at this point. It uses the map_ functions, which are a part of the purrr package of the tidyverse. The map_ functions can typically replace for loops in R, offer performance benefits, and allow you to write shorter code. However, they come with a level of incredible complexity that I can't follow any more. You're doing a lot "behind the curtain" kind of like you can do with group_by() %>% summarize(), but it extends beyond doing simple math on each individual group and extends it to more complex operations.

# individual_disability <- survey_by_demog(filter(disability_data, year == 2023), 
#                                          "dis_physical", 
#                                          "PERWT",
#                                          method = "bootstrap",
#                                          breakdowns = "total")

```

# American Community Survey (ACS)

The following section summarizes findings from ACS data on disability prevalence in Louisville, KY, highlighting how factors like race, sex, income, and age relate to disability rates.

<details>
<summary> <i> See variable definitions </i> </summary> 
```{r, echo=FALSE, eval=TRUE}
library(knitr)
library(kableExtra)
defs <- data.frame(
  Variable = c("Ambulatory difficulty",
    "Independent living difficulty",
    "Self-care difficulty",
    "Vision difficulty",
    "Hearing difficulty"),
  Description = c("DIFFPHYS- Indicates whether the respondent has a condition that substantially limits one or more basic physical activities, such as walking, climbing stairs, reaching, lifting, or carrying.",
                  "DIFFMOB- Indicates whether the respondent has any physical, mental, or emotional condition lasting six months or more that makes it difficult or impossible to perform basic activities outside the home alone. Does not include temporary health problems.",
                  "DIFFCARE- Indicates whether respondents have any physical or mental health condition that has lasted at least six months and makes it difficult to take care of their own personal needs (bathing, dressing, getting around inside the home). Excludes temporary conditions.",
                  "DIFFEYE- Indicates whether the respondent is blind or has serious difficulty seeing even with corrective lenses.",
                  "DIFFHEAR- Indicates whether the respondent is deaf or has serious difficulty hearing."))

#convert data frame to markdown table 
kable(defs, "html", escape = FALSE, col.names = c("Variable", "Description")) %>%
  kable_styling(
    full_width = FALSE,
    position = "center",
    #alternate row colors, reduce padding, scroll if on mobile
    bootstrap_options = c("striped", "condensed", "responsive")
  )
```
</details>

## Trends Across Demographics (2023)

### Overall {.tabset}

#### Individual

```{r prevalence_chart_indv}

load("interim_data/clean_disability_data.RData")
showtext_auto()

#mutate dfs to plot

# chart 1 -> prevalence of disabilities by type
# only most recent year (can change)
dis_prev_by_type <- individual_dis %>%
  filter(year ==2023, var_type == "percent", sex == "total", race == "total") %>%
  pivot_longer(cols = c(dis_physical, dis_independent, dis_selfcare, dis_vision, dis_hearing, dis_any),
               names_to = "Disability_Type", 
               values_to = "Percent") %>%
  select(6,7) %>%
  mutate(Disability_Type = recode(Disability_Type, dis_physical = "Physical",
                                  dis_independent = "Ind. Living",
                                  dis_selfcare = "Self-Care",
                                  dis_vision = "Vision",
                                  dis_hearing = "Hearing",
                                  dis_any = "Any")) %>%
  select(Disability_Type, Percent)

save(dis_prev_by_type, file= "interim_data/dis_prev_by_type.Rdata")

dis_prev_by_type$Percent <- round(dis_prev_by_type$Percent, 2)

# now to actually plot them eek
#update not so cute but we can prettify later 
plot1 <- ggplot(dis_prev_by_type, aes(x = Disability_Type, y = Percent)) +
  geom_col(fill = "#f60", width = .5) +
  geom_text(aes(label = paste0(Percent, "%")), 
            vjust = -0.5, size = 6) +
  labs(
    title = "Prevalence of Disabilities by Type (2023)",
    x = NULL,
    y = "Percent of Population"
  ) +
 theme_minimal(base_family = "Montserrat",base_size =  22) +
  theme(
    axis.text.x = element_text(angle = 30, hjust= 1, family = "Montserrat"),
    plot.title = element_text(face = "bold", size = 26, family = "Montserrat"),
  )
  print(plot1)

  ggsave("interim_data/plots/dis_by_type.png", plot= plot1)
  
```

#### Household

```{r prevalence_chart_HH}
load(file = "interim_data/clean_disability_data.RData")
showtext_auto()


HH_prev <- household_dis %>%
  filter(year == 2023, var_type == "percent") %>%
  pivot_longer(cols = c(any_dis_physical, any_dis_independent, any_dis_selfcare, any_dis_vision, any_dis_hearing, any_dis_any),
               names_to = "Disability_Type", 
               values_to = "Percent") %>%
  select(-race, -sex, -var_type, -FIPS) %>%
  mutate(Disability_Type = recode(Disability_Type, any_dis_physical = "Physical",
                                  any_dis_independent = "Ind. Living",
                                  any_dis_selfcare = "Self-Care",
                                  any_dis_vision = "Vision",
                                  any_dis_hearing = "Hearing",
                                  any_dis_any = "Any")) %>%
  select(Disability_Type, Percent)

save(HH_prev, file= "interim_data/HH_prev.Rdata")

HH_prev$Percent <- round(HH_prev$Percent, 2)

HH_prev_plot <- ggplot(HH_prev, aes(x = Disability_Type, y = Percent)) +
  geom_col(fill = "#f60", width = .5) +
  geom_text(aes(label = paste0(Percent, "%")), vjust = -0.5, size = 6) +
  labs(
    title = "Households with a Person with a Disability by Type (2023)", 
    subtitle = "Household Level", 
    x = NULL,
    y = "Percent of Households"
  ) +
 theme_minimal(base_family = "Montserrat",base_size =  22) +
  theme(
    axis.text.x = element_text(angle = 30, hjust= 1,family = "Montserrat"),
    plot.title = element_text(face = "bold", size = 26, family = "Montserrat")
  )
  print(HH_prev_plot)

  ggsave("interim_data/plots/HH_prev_plot.png", plot= HH_prev_plot)
```

### Sex

```{r sex_chart}

showtext_auto()
colors <- c("#f60", "#FFCCC2")

  #clean table- extract relevant columns, values 
dis_by_sex <- individual_dis %>%
  filter(year ==2023, var_type == "percent", sex != "total", race == "total") %>%
  pivot_longer(cols = c(dis_physical, dis_independent, dis_selfcare, dis_vision, dis_hearing, dis_any),
               names_to = "Disability_Type", 
               values_to = "Percent") %>%
  select(3,6,7) %>%
  mutate(Disability_Type = recode(Disability_Type,
                                  dis_physical = "Physical",
                                  dis_independent = "Ind. Living",
                                  dis_selfcare = "Self-Care",
                                  dis_vision = "Vision",
                                  dis_hearing = "Hearing",
                                  dis_any = "Any")) %>%
  mutate(sex = recode(sex, 
                      male = "Male", 
                      female = "Female")) %>% 
 rename(Sex = sex)

  #create chart
plot2 <- ggplot(dis_by_sex, aes(x = Disability_Type, y = Percent, fill = Sex)) +  # fill says split x category by sex
  geom_col(position = position_dodge(width = 0.5), width = 0.5) + #dodge = side by side not stacked 
  labs(
    title = "Disabilities Breakdown by Sex (2023)",
    x = NULL,
    y = "Percent of Population"
  ) +
  scale_fill_manual(values = colors) +  
 theme_minimal(base_family = "Montserrat", base_size = 22) +
  theme(
    axis.text.x = element_text(angle = 30, hjust = 1, family = "Montserrat"),
    plot.title = element_text(face = "bold", size = 26, family = "Montserrat")
  )
  print(plot2)
  ggsave("interim_data/plots/dis_by_sex.png", plot= plot2)
  
```

### Race

```{r race_chart}

showtext_auto()
colors <- colorRampPalette(c("#FFCCC2", "#cc3f14"))(4)

  #clean table
dis_by_race <- individual_dis %>%
  filter(year == 2023, var_type == "percent", race != "total", sex == "total") %>%
  pivot_longer(cols = c(dis_physical, dis_independent, dis_selfcare, dis_vision, dis_hearing, dis_any),
               names_to = "Disability_Type", 
               values_to = "Percent") %>%
  select(4,6,7) %>%
  mutate(Disability_Type = recode(Disability_Type,
                                  dis_physical = "Physical",
                                  dis_independent = "Ind. Living",
                                  dis_selfcare = "Self-Care",
                                  dis_vision = "Vision",
                                  dis_hearing = "Hearing",
                                  dis_any = "Any")) %>%
  mutate(race = recode(race, 
                      black = "Black", 
                      hispanic = "Hispanic", 
                      white = "White", 
                      other = "Not Listed")) %>% 
  rename(Race = race)

  #make chart
plot3 <- ggplot(dis_by_race, aes(x = Disability_Type, y = Percent, fill = Race)) +  # fill says split x category by sex
  geom_col(position = position_dodge(width = 0.5), width = 0.5) + #dodge = side by side not stacked 
  labs(
    title = "Disabilities Breakdown by Race (2023)",
    x = NULL, y = "Percent of Population"
  ) +
  scale_fill_manual(values = colors) +  
 theme_minimal(base_family = "Montserrat", base_size = 22) +
  theme(
    axis.text.x = element_text(angle = 30, hjust = 1, family = "Montserrat"),
    plot.title = element_text(face = "bold", size = 26, family = "Montserrat")
  )

  ggsave("interim_data/plots/dis_by_race.png", plot= plot3)
  print(plot3)
```

### Own vs. Rent {.tabset}

#### Individual

```{r homeownership_individual_graph}
load("interim_data/homeownership_all_dis.RData")

showtext_auto()
colors <- c("#f60", "#FFCCC2")

#clean it
dis_by_own <- homeownership_all %>%
  filter(year == 2023, var_type == "percent", sex == "total", race == "total", !is.na(homeownership)) %>%
  pivot_longer(cols = c(dis_physical, dis_independent, dis_selfcare, dis_vision, dis_hearing, dis_any),
               names_to = "Disability_Type", 
               values_to = "Percent") %>%
  select(homeownership, Disability_Type,Percent) %>%
  mutate(
    Disability_Type = recode(Disability_Type,
                             dis_physical = "Physical",
                             dis_independent = "Ind. Living",
                             dis_selfcare = "Self-Care",
                             dis_vision = "Vision",
                             dis_hearing = "Hearing",
                             dis_any = "Any"),
    Homeownership = if_else(homeownership, "Owns", "Rents")
  ) %>%
  select(-homeownership)

#chart it!
plot6 <- ggplot(dis_by_own, aes(x = Disability_Type, y = Percent, fill = Homeownership)) +  # fill says split x category by this category
  geom_col(position = position_dodge(width = 0.5), width = 0.5) + #dodge = side by side not stacked 
  labs(
    title = "Disabilities Breakdown by Homeownership (2023)",
    x = NULL, y = "Percent of Population"
  ) +
  scale_fill_manual(values = colors) +  
 theme_minimal(base_family = "Montserrat", base_size = 22) +
  theme(
    axis.text.x = element_text(angle = 30, hjust = 1, family = "Montserrat"),
    plot.title = element_text(face = "bold", size = 26, family = "Montserrat")
  )

  ggsave("interim_data/plots/dis_by_homeownership.png", plot= plot6)
  print(plot6)

```

#### Household

```{r hh_homeownership_graph}

showtext_auto()
load("interim_data/hh_homeownership_all_dis.RData")
colors <- c("#f60", "#FFCCC2")

#clean it
hh_dis_by_own <- hh_homeownership_all %>%
  filter(year == 2023, var_type == "percent", sex == "total", race == "total", !is.na(homeownership)) %>%
  pivot_longer(cols = c(dis_physical, dis_independent, dis_selfcare, dis_vision, dis_hearing, dis_any),
               names_to = "Disability_Type", 
               values_to = "Percent") %>%
  select(homeownership, Disability_Type,Percent) %>%
  mutate(
    Disability_Type = recode(Disability_Type,
                             dis_physical = "Physical",
                             dis_independent = "Ind. Living",
                             dis_selfcare = "Self-Care",
                             dis_vision = "Vision",
                             dis_hearing = "Hearing",
                             dis_any = "Any"),
    Homeownership = if_else(homeownership, "Owns", "Rents")
  ) %>%
  select(-homeownership)

#chart it!
hh_own_rent <- ggplot(hh_dis_by_own, aes(x = Disability_Type, y = Percent, fill = Homeownership)) +  # fill says split x category by this category
  geom_col(position = position_dodge(width = 0.5), width = 0.5) + #dodge = side by side not stacked 
  labs(
    title = "Disabilities Breakdown by Homeownership (2023)",
    subtitle = "Household Level", 
    x = NULL, y = "Percent of Households"
  ) +
  scale_fill_manual(values = colors) +  
 theme_minimal(base_family = "Montserrat", base_size = 22) +
  theme(
    axis.text.x = element_text(angle = 30, hjust = 1, family = "Montserrat"),
    plot.title = element_text(face = "bold", size = 26, family = "Montserrat")
  )

  ggsave("interim_data/plots/hh_dis_by_homeownership.png", plot= hh_own_rent)
  print(hh_own_rent)

```

### Income {.tabset}

#### Individual

```{r income_chart}
load("interim_data/income_6_all_dis.RData")
showtext_auto()
colors <- colorRampPalette(c("#FFCCC2", "#cc3f14"))(6)

#clean it
dis_by_income <- income_all %>%
  filter(year == 2023, var_type == "percent", sex == "total", race == "total") %>%
  pivot_longer(cols = c(dis_physical, dis_independent, dis_selfcare, dis_vision, dis_hearing, dis_any),
               names_to = "Disability_Type", 
               values_to = "Percent") %>%
  select(income_group, Disability_Type,Percent) %>%
  mutate(Disability_Type = recode(Disability_Type, dis_physical = "Physical",
                                  dis_independent = "Ind. Living",
                                  dis_selfcare = "Self-Care",
                                  dis_vision = "Vision",
                                  dis_hearing = "Hearing",
                                  dis_any = "Any")) %>%
rename("Income Group" = income_group)

#chart it!
plot4 <- ggplot(dis_by_income, aes(x = Disability_Type, y = Percent, fill = `Income Group`)) +  # fill says split x category by this category
  geom_col(position = position_dodge(width = 0.5), width = 0.5) + #dodge = side by side not stacked 
  labs(
    title = "Disabilities Breakdown by Income (2023)",
    x = NULL, y = "Percent of Population"
  ) +
  scale_fill_manual(values = colors) +  
 theme_minimal(base_family = "Montserrat", base_size = 22) +
  theme(
    axis.text.x = element_text(angle = 30, hjust = 1, family = "Montserrat"),
    plot.title = element_text(face = "bold", size = 26, family = "Montserrat")
  )

  ggsave("interim_data/plots/dis_by_income.png", plot= plot4)
  print(plot4)
  
```

#### Household

```{r hh_income_graph}

showtext_auto()
load("interim_data/hh_income_all_dis.RData")
colors <- colorRampPalette(c("#FFCCC2", "#cc3f14"))(6)

#clean it
hh_dis_by_own <- hh_income_all %>%
  filter(year == 2023, var_type == "percent", sex == "total", race == "total", !is.na(income_group)) %>%
  pivot_longer(cols = c(dis_physical, dis_independent, dis_selfcare, dis_vision, dis_hearing, dis_any),
               names_to = "Disability_Type", 
               values_to = "Percent") %>%
  select(income_group, Disability_Type,Percent) %>%
  mutate(
    Disability_Type = recode(Disability_Type,
                             dis_physical = "Physical",
                             dis_independent = "Ind. Living",
                             dis_selfcare = "Self-Care",
                             dis_vision = "Vision",
                             dis_hearing = "Hearing",
                             dis_any = "Any")) %>%
  rename("Income Group" = income_group)

#chart it!
hh_income <- ggplot(hh_dis_by_own, aes(x = Disability_Type, y = Percent, fill = `Income Group`)) +  # fill says split x category by this category
  geom_col(position = position_dodge(width = 0.5), width = 0.5) + #dodge = side by side not stacked 
  labs(
    title = "Disabilities Breakdown by Income (2023)",
    subtitle = "Household Level", 
    x = NULL, y = "Percent of Households"
  ) +
  scale_fill_manual(values = colors) +  
 theme_minimal(base_family = "Montserrat", base_size = 22) +
  theme(
    axis.text.x = element_text(angle = 30, hjust = 1, family = "Montserrat"),
    plot.title = element_text(face = "bold", size = 26, family = "Montserrat")
  )

  ggsave("interim_data/plots/hh_dis_by_income.png", plot= hh_income)
  print(hh_income)

```

### Age {.tabset}

#### All Ages

```{r age_chart}
load(file = "interim_data/age_4_all_dis.RData")
showtext_auto()
colors <- colorRampPalette(c("#FFCCC2", "#cc3f14"))(4)

#clean table
dis_by_age <- age_all %>%
  filter(year == 2023, sex == "total", race == "total", var_type == "percent",!is.na(age_group_4)) %>%
  pivot_longer(cols = c(dis_physical, dis_independent, dis_selfcare, dis_vision, dis_hearing, dis_any),
               names_to = "Disability_Type", 
               values_to = "Percent") %>% 
  mutate(Disability_Type = recode(Disability_Type, dis_physical = "Physical",
                                  dis_independent = "Ind. Living",
                                  dis_selfcare = "Self-Care",
                                  dis_vision = "Vision",
                                  dis_hearing = "Hearing",
                                  dis_any = "Any")) %>%
  select(age_group_4, Disability_Type, Percent) %>% 
  rename(Age = age_group_4)

#chart it!
plot5 <- ggplot(dis_by_age, aes(x = Disability_Type, y = Percent, fill = Age)) +  # fill says split x category by this category
  geom_col(position = position_dodge(width = 0.5), width = 0.5) + #dodge = side by side not stacked 
  labs(
    title = "Disabilities Breakdown by Age (2023)",
    x = NULL, y = "Percent of Population"
  ) +
  scale_fill_manual(values = colors) +  
 theme_minimal(base_family = "Montserrat", base_size = 22) +
  theme(
    axis.text.x = element_text(angle = 30, hjust = 1, family = "Montserrat"),
    plot.title = element_text(face = "bold", size = 26, family = "Montserrat")
  )

  ggsave("interim_data/plots/dis_by_age.png", plot= plot5)
  print(plot5)
```

#### Older Subset

```{r age_5yr_chart}
load(file = "interim_data/age_5yr_all_dis.RData")
showtext_auto()
colors <- colorRampPalette(c("#FFCCC2", "#cc3f14"))(8)

#clean table
dis_by_age <- age_all_5yr %>%
  filter(year == 2023, sex == "total", race == "total", var_type == "percent",!is.na(age_group_5yr)) %>%
  pivot_longer(cols = c(dis_physical, dis_independent, dis_selfcare, dis_vision, dis_hearing, dis_any),
               names_to = "Disability_Type", 
               values_to = "Percent") %>% 
  mutate(Disability_Type = recode(Disability_Type, dis_physical = "Physical",
                                  dis_independent = "Ind. Living",
                                  dis_selfcare = "Self-Care",
                                  dis_vision = "Vision",
                                  dis_hearing = "Hearing",
                                  dis_any = "Any")) %>%
  select(age_group_5yr, Disability_Type, Percent) %>% 
  rename(Age = age_group_5yr)

plot5yr <- ggplot(dis_by_age, aes(x = Disability_Type, y = Percent, fill = Age)) +  # fill says split x category by this category
  geom_col(position = position_dodge(width = 0.5), width = 0.5) + #dodge = side by side not stacked 
  labs(
    title = "Disabilities Breakdown by Age- 50+ (2023)",
    x = NULL, y = "Percent of Population"
  ) +
  scale_fill_manual(values = colors) +  
 theme_minimal(base_family = "Montserrat", base_size = 22) +
  theme(
    axis.text.x = element_text(angle = 30, hjust = 1, family = "Montserrat"),
    plot.title = element_text(face = "bold", size = 26, family = "Montserrat")
  )

  ggsave("interim_data/plots/dis_by_age_5yr.png", plot= plot5yr)
  print(plot5yr)
```

## Trends Over Time (2008-2023)

*Note missing data for the year 2020*

### Overall

```{r overtime_overall}
load("interim_data/clean_disability_data.RData")
showtext_auto()
colors <- colorRampPalette(c("#FFCCC2", "#cc3f14"))(5)
all_color <- "#52b899"

dis_prev_by_type_over_time <- individual_dis %>%
  filter(var_type == "percent", sex == "total", race == "total") %>%
  pivot_longer(cols = c(dis_physical, dis_independent, dis_selfcare, dis_vision, dis_hearing, dis_any),
               names_to = "Disability_Type", 
               values_to = "Percent") %>%
  mutate(Disability_Type = recode(Disability_Type, dis_physical = "Physical",
                                  dis_independent = "Ind. Living",
                                  dis_selfcare = "Self-Care",
                                  dis_vision = "Vision",
                                  dis_hearing = "Hearing",
                                  dis_any = "Any")) %>%
  select(year, Disability_Type, Percent)

plot_overall_time <- ggplot(dis_prev_by_type_over_time, aes(x = year, y = Percent, color = Disability_Type, group = Disability_Type)) +
  geom_line(size = 1.2) +                      
  geom_point(size = 2) + #points on the year (optional)                      
  labs(
    title = "Disability Trends Over Time",
    x = NULL,
    y = "Percent of Population"
  ) +
 theme_minimal(base_family = "Montserrat", base_size = 22) +
  scale_x_continuous(
    breaks = seq(min(dis_prev_by_type_over_time$year), max(dis_prev_by_type_over_time$year), by = 2)  #every other year
  ) +
  scale_color_manual(values = c("Any" = all_color, "Ind. Living" = colors[1], "Self-Care" = colors[2], "Hearing" = colors[3], "Physical" = colors[4] , "Vision" = colors[5])) +
  theme(
    axis.text.x = element_text(angle = 45, hjust = 1, family = "Montserrat"),
    plot.title = element_text(face = "bold", size = 26, family = "Montserrat"),
    legend.position = "top"
  )

ggsave("interim_data/plots/dis_prev_by_type_over_time.png", plot = plot_overall_time)
print(plot_overall_time)


```

### Sex

```{r sex_chart_time}
load(file = "interim_data/clean_disability_data.RData")
showtext_auto()
colors <- c("#f60", "#FFCCC2")

#phys_disability and sex over time
sex_over_time<- individual_dis %>%
  filter(sex %in% c("male", "female"), var_type == "percent", race == "total") %>% 
  select(year, sex, dis_physical) %>%
mutate(sex = recode(sex, 
                      male = "Male", 
                      female = "Female")) %>% 
 rename(Sex = sex)

plot_sex_time <- ggplot(sex_over_time, aes(x = year, y = dis_physical, color = Sex, group = Sex)) +
  geom_line(size = 1.2) +                      
  geom_point(size = 2) + #points on the year (optional)                      
  labs(
    title = "Physical Disability Over Time by Sex",
    x = NULL,
    y = "Percent of Population"
  ) +
  scale_color_manual(values = colors) +
 theme_minimal(base_family = "Montserrat", base_size = 22) +
  scale_x_continuous(
    breaks = seq(min(sex_over_time$year), max(sex_over_time$year), by = 2)  #every other year
  ) +
  theme(
    axis.text.x = element_text(angle = 45, hjust = 1, family = "Montserrat"),
    plot.title = element_text(face = "bold", size = 26, family = "Montserrat"),
    legend.position = "top"
  )

ggsave("interim_data/plots/dis_physical_by_sex_time.png", plot = plot_sex_time)
print(plot_sex_time)
```

### Race

```{r race_chart_time}
load(file = "interim_data/clean_disability_data.RData")
showtext_auto()
colors <- colorRampPalette(c("#FFCCC2", "#cc3f14"))(4)

#phys_disability and race over time
race_over_time<- individual_dis %>%
  filter(race != "total", sex == "total", var_type == "percent") %>% 
  select(year, race, dis_physical) %>%
mutate(race = recode(race, 
                      white = "White", black = "Black", hispanic = "Hispanic", other= "Not Listed" )) %>% 
 rename(Race = race)


plot_race_time <- ggplot(race_over_time, aes(x = year, y = dis_physical, color = Race, group = Race)) +
  geom_line(size = 1.2) +                      
  geom_point(size = 2) + #points on the year (optional)                      
  labs(
    title = "Physical Disability Over Time by Race",
    x = NULL,
    y = "Percent of Population"
  ) +
  scale_color_manual(values = colors) +
  theme_minimal(base_family = "Montserrat", base_size = 22) +
  scale_x_continuous(
    breaks = seq(min(race_over_time$year), max(race_over_time$year), by = 2) 
  ) +
  theme(
    axis.text.x = element_text(angle = 45, hjust = 1, family = "Montserrat"),
    plot.title = element_text(face = "bold", size = 26, family = "Montserrat"),
    legend.position = "top"
  )

ggsave("interim_data/plots/dis_physical_by_race_time.png", plot = plot_race_time)
print(plot_race_time)
```

### Own Vs Rent

```{r own_vs_rent_time}
load(file = "interim_data/clean_disability_data.RData")
showtext_auto()
colors <- c("#f60", "#FFCCC2")

#phys_disability and race over time
homeownership_over_time<- individual_dis_homeownership %>%
  filter(year %in% c(2008, 2010, 2012, 2014, 2016, 2018, 2021, 2023), race == "total", sex == "total", !is.na(homeownership), var_type == "percent") %>%
  select(year, homeownership, dis_physical) %>%
  mutate(Homeownership = if_else(homeownership, "Owns", "Rents")
  ) %>%
  select(-homeownership)

plot_owns_time <- ggplot(homeownership_over_time, aes(x = year, y = dis_physical, color = Homeownership, group = Homeownership)) +
  geom_line(size = 1.2) +                      
  geom_point(size = 2) + #points on the year (optional)                      
  labs(
    title = "Physical Disability Over Time by Homeownership",
    x = NULL,
    y = "Percent of Population"
  ) +
  scale_color_manual(values = colors) +
 theme_minimal(base_family = "Montserrat", base_size = 22) +
  scale_x_continuous(
    breaks = seq(min(homeownership_over_time$year), max(homeownership_over_time$year), by = 2) 
  ) +
  theme(
    axis.text.x = element_text(angle = 45, hjust = 1, family = "Montserrat"),
    plot.title = element_text(face = "bold", size = 26, family = "Montserrat"),
    legend.position = "top"
  )

ggsave("interim_data/plots/dis_physical_by_owns_time.png", plot = plot_owns_time)
print(plot_owns_time)
```

### Income

```{r income_graph_time}
load(file = "interim_data/clean_disability_data.RData")
showtext_auto()
income_levels <- c("Under 20k", "20k–49.9k","50k–74.9k", "75k–99.9k", "100k–149.9k", "150k+")

individual_dis_income <- individual_dis_income %>%
  mutate(income_group = factor(income_group, levels = income_levels))

colors <- colorRampPalette(c("#FFCCC2", "#cc3f14"))(6)

income_over_time<- individual_dis_income %>%
  filter(year %in% c(2008, 2010, 2012, 2014, 2016, 2018, 2021, 2023), race == "total", sex == "total", var_type == "percent") %>%
  select(year, income_group, dis_physical) %>%
  rename(Income = income_group)

plot_income_time <- ggplot(income_over_time, aes(x = year, y = dis_physical, color= Income, group = Income)) +
  geom_line(size = 1.2) +                      
  geom_point(size = 2) + #points on the year (optional)                      
  labs(
    title = "Physical Disability Over Time by Income Group",
    x = NULL,
    y = "Percent of Population"
  ) +
  scale_color_manual(values = colors) +
 theme_minimal(base_family = "Montserrat", base_size = 22) +
  scale_x_continuous(
    breaks = seq(min(income_over_time$year), max(income_over_time$year), by = 2)  #every other year
  ) +
  theme(
    axis.text.x = element_text(angle = 45, hjust = 1, family = "Montserrat"),
    plot.title = element_text(face = "bold", size = 26, family = "Montserrat"),
    legend.position = "top"
  )

ggsave("interim_data/plots/dis_physical_by_income_time.png", plot = plot_income_time)
print(plot_income_time)
```

### Age

```{r age_graph_time}
load(file = "interim_data/clean_disability_data.RData")
showtext_auto()
age_levels <- c("Under 50", "50-64", "65-80", "80 or Older")

colors <- colorRampPalette(c("#FFCCC2", "#cc3f14"))(4)

individual_dis_age_4 <- individual_dis_age_4 %>%
  mutate(age_group_4 = factor(age_group_4, levels = age_levels, ordered = TRUE))

age_over_time<- individual_dis_age_4 %>%
  filter(year %in% c(2008, 2010, 2012, 2014, 2016, 2018, 2021, 2023), race == "total", sex == "total", !is.na(age_group_4), var_type == "percent") %>%
  select(year, age_group_4, dis_physical) %>%
  rename(Age = age_group_4)
  

plot_age_time <- ggplot(age_over_time, aes(x = year, y = dis_physical, color= Age, group = Age)) +
  geom_line(size = 1.2) +                      
  geom_point(size = 2) + #points on the year (optional)                      
  labs(
    title = "Physical Disability Over Time by Age Group",
    x = NULL,
    y = "Percent of Population"
  ) +
  scale_color_manual(values = colors) +
 theme_minimal(base_family = "Montserrat", base_size = 22) +
  scale_x_continuous(
    breaks = seq(min(age_over_time$year), max(age_over_time$year), by = 2)  #every other year
  ) +
  theme(
    axis.text.x = element_text(angle = 45, hjust = 1, family = "Montserrat"),
    plot.title = element_text(face = "bold", size = 26, family = "Montserrat"),
    legend.position = "top"
  )

ggsave("interim_data/plots/dis_physical_by_age_time.png", plot = plot_age_time)
print(plot_age_time)
```

# Kentucky Housing Corporation (KHC)

Below is a graph showing the number of accessible units in various housing developments provided by KHC. The total number of housing units in the data set was 35,862, making the largest category of accessible units (all categories combined) about 3.59% of units. *Note: The differences in unit features based on categories ADA compliant, Physical Disabilities, and Special Needs have not yet been defined.*

```{r KHC}
# NOTE- this code was generated in part by an LLM converting the python code found in KHC_analysis.Rmd into R code. Results of this code have been cross checked with original (python) results to verify accuracy of code

library(readxl)
library(dplyr)
library(ggplot2)
showtext_auto()

# Load the Excel file
df <- read_excel("data/KHC Project Listings by Unit Category.xlsx")

# Total units
total_units <- sum(df$Units, na.rm = TRUE)

# Summarize by category
summary_df <- tibble(
  Category = c("ADA Compliant", "Physical Disabilities", "Special Needs")
) %>%
  rowwise() %>%
  mutate(
    Units = case_when(
      Category == "ADA Compliant" ~ sum(df$Units[grepl("ADA", df$`Unit Category`, ignore.case = TRUE)], na.rm = TRUE),
      Category == "Physical Disabilities" ~ sum(df$Units[
        grepl("Physical", df$`Unit Type`, ignore.case = TRUE) & 
        !grepl("ADA", df$`Unit Category`, ignore.case = TRUE)
      ], na.rm = TRUE),
      Category == "Special Needs" ~ sum(df$Units[grepl("Special", df$`Unit Category`, ignore.case = TRUE)], na.rm = TRUE)
    ),
    Percent = Units / total_units * 100
  ) %>%
  ungroup()

# Optionally add a row for "All Accessible"
summary_df <- summary_df %>%
  add_row(
    Category = "All Accessible",
    Units = sum(summary_df$Units),
    Percent = sum(summary_df$Percent)
  )

plot_summary <- ggplot(summary_df, aes(x = Category, y = Units)) +
  geom_col(fill = "#f60", width = 0.5) +
  geom_text(
    aes(label = Units),
    vjust = -0.4,                 # position above bars
    size = 6,                   # readable label size
    fontface = "bold"
  ) +
  labs(
    title = "KHC Accessible Units",
    subtitle = "Categories below are listed as defined in data provided by KHC",
    x = NULL,
    y = "Number of Units"
  ) +
  theme_minimal(base_family = "Montserrat", base_size = 22) +
  theme(
    axis.text.x = element_text(angle = 30,  hjust = 1, family = "Montserrat"),
    plot.title = element_text(face = "bold", size = 26, family = "Montserrat")
  )

print(plot_summary)
```
